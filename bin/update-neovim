#!/usr/bin/env bash

set -eEuo pipefail
trap "echo 'An unknown error occurred'" ERR

nvim_url="https://github.com/neovim/neovim/releases/download/stable/nvim.appimage"
checksum_url="https://github.com/neovim/neovim/releases/download/stable/nvim.appimage.sha256sum"

nvim_filename="$(basename "${nvim_url}")"
checksum_filename="$(basename "${checksum_url}")"

# Change into a temporary directory
cd "$(mktemp -d)"

printf "Downloading latest stable release from github.com/neovim/neovim\n\n"

# Download the files
curl -fSL --progress-bar "${nvim_url}" --output "${nvim_filename}"
curl -fSL --progress-bar "${checksum_url}" --output "${checksum_filename}"

# Check the checksum
if ! [[ "$(sha256sum "${nvim_filename}")" == "$(cat "${checksum_filename}")" ]]; then
    echo "Checksum comparison failed! Exiting..."
    exit 0
fi

printf "\nChecksum verified, installing...\n\n"

# Install to path
sudo mv ./nvim.appimage /usr/local/bin/nvim
sudo chmod +x /usr/local/bin/nvim

printf "Neovim installed successfully! Printing neovim version information:\n\n"
# Print out version information
/usr/local/bin/nvim --version
