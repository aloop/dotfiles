#!/usr/bin/env python3
"""Dotfiles management"""

import argparse
import configparser
import logging as log
import os
from pathlib import Path

from lib.dotfiles import Dotfiles

# Set a restrictive default umask
os.umask(0o077)

dotfiles_dir = Path(os.path.dirname(os.path.realpath(__file__)))
default_ignore_list: list[str | Path] = []

_env_defaults: dict[str, Path] = {}

config = configparser.ConfigParser()
config.optionxform = str  # type: ignore
config.read(dotfiles_dir / "config.ini")

if config.has_section("env.fallbacks"):
    for key, value in config.items("env.fallbacks"):
        _env_defaults[key] = Path(value)


def df_cmd_setup(parser):
    parser.add_argument(
        "--no-backups",
        action="store_true",
        help=("Do not backup existing files from the home directory"),
    )
    parser.add_argument(
        "--ignore",
        metavar="FILENAME",
        action="append",
        nargs="+",
        help=("Specify one or more files or folders to ignore"),
    )


def main():
    dotfiles = Dotfiles(config, dotfiles_dir, _env_defaults, default_ignore_list)

    file_description = "a simple way to manage dotfiles."

    parentp = argparse.ArgumentParser(add_help=False)

    parentp.add_argument(
        "-v", "--verbose", action="store_true", help="Show more verbose output"
    )

    parser = argparse.ArgumentParser(parents=[parentp], description=file_description)

    subp = parser.add_subparsers(title="commands")

    subparser_definitions = [
        ["install", "Install all dotfiles", dotfiles.install, df_cmd_setup],
        ["link", "Install dotfile links", dotfiles.link, df_cmd_setup],
        ["hardlink", "Install dotfile hardlinks", dotfiles.hardlink, df_cmd_setup],
        ["copy", "Install dotfile copies", dotfiles.copy, df_cmd_setup],
    ]

    for name, help_, func, setup in subparser_definitions:
        cmd_parser = subp.add_parser(name, help=help_, parents=[parentp])
        cmd_parser.set_defaults(func=func)
        if setup is not None:
            setup(cmd_parser)

    args = parser.parse_args()

    log_format = "%(levelname)s: %(message)s"
    log_level = log.INFO if args.verbose else log.WARNING

    log.basicConfig(format=log_format, level=log_level)

    if "func" in args:
        try:
            args.func(args)
        except IOError:
            log.exception("Error processing dotfiles:")
            parser.exit(1)
    else:
        parser.print_usage()


if __name__ == "__main__":
    main()
